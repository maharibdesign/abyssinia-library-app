---
// src/pages/favorites.astro
import MainLayout from '../layouts/MainLayout.astro';
import { getCollection } from 'astro:content';

// We no longer import the FavoriteButton here because it's handled by the script.
const allSummaries = await getCollection('summaries');
---

<MainLayout title="My Favorites">
  <h1 class="page-title">My Favorites</h1>
  <p id="no-favorites-message" style="display: none;">You haven't favorited any summaries yet. Go back <a href="/">home</a> to find some!</p>

  <div class="summary-grid" id="favorites-grid">
    <!-- UPDATE: The template is now much simpler. It just contains a placeholder button. -->
    <template id="favorite-card-template">
      <a href="" class="summary-card">
        <button class="favorite-btn" aria-label="Favorite this book">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
          </svg>
        </button>
        <div class="card-content">
          <h2 class="card-title"></h2>
          <p class="card-author"></p>
          <span class="card-category"></span>
        </div>
      </a>
    </template>
  </div>
</MainLayout>

<!-- UPDATE: The script is now more efficient. -->
<script define:vars={{ allSummaries }}>
  import { favoriteSummaries, toggleFavorite } from '../lib/favoritesStore';

  const grid = document.getElementById('favorites-grid');
  const template = document.getElementById('favorite-card-template');
  const noFavoritesMessage = document.getElementById('no-favorites-message');

  function renderFavorites() {
    const favorites = favoriteSummaries.get();
    const favoriteSlugs = Object.keys(favorites);

    grid.innerHTML = '';

    if (favoriteSlugs.length === 0) {
      noFavoritesMessage.style.display = 'block';
    } else {
      noFavoritesMessage.style.display = 'none';
    }

    const favoritedSummaries = allSummaries.filter(summary => favoriteSlugs.includes(summary.slug));

    favoritedSummaries.forEach(summary => {
      const cardFragment = template.content.cloneNode(true);
      const card = cardFragment.firstElementChild;
      
      card.href = `/summaries/${summary.slug}`;
      card.querySelector('.card-title').textContent = summary.data.title;
      card.querySelector('.card-author').textContent = `by ${summary.data.author}`;
      card.querySelector('.card-category').textContent = summary.data.category;
      
      const favButton = card.querySelector('.favorite-btn');
      favButton.dataset.bookSlug = summary.slug;
      
      if (favorites[summary.slug]) {
        favButton.classList.add('favorited');
      }

      grid.appendChild(card);
    });
  }

  // Use a single "event listener" on the whole grid for better performance.
  grid.addEventListener('click', (e) => {
    const button = e.target.closest('.favorite-btn');
    if (button) {
      e.preventDefault();
      e.stopPropagation();
      const slug = button.dataset.bookSlug;
      if (slug) {
        toggleFavorite(slug);
      }
    }
  });
  
  // When the favorites data changes, re-render the list.
  favoriteSummaries.listen(renderFavorites);
  
  // Render the list for the first time when the page loads.
  renderFavorites();
</script>

<style is:global>
  /* These styles are unchanged but are needed for the cards to look right. */
  .page-title { border-bottom: 1px solid var(--color-border); padding-bottom: 0.5rem; margin-bottom: 2rem; }
  .summary-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
  @media (min-width: 640px) { .summary-grid { grid-template-columns: repeat(2, 1fr); } }
  .summary-card { position: relative; display: block; background-color: var(--color-card-bg); border: 1px solid var(--color-border); border-radius: 6px; padding: 1.5rem; text-decoration: none; color: var(--color-text); transition: transform 0.2s ease, border-color 0.2s ease; }
  .summary-card:hover { transform: translateY(-5px); border-color: var(--color-primary); }
  .card-title { margin: 0 0 0.25rem 0; font-size: 1.25rem; }
  .card-author { margin: 0 0 1rem 0; color: #8b949e; }
  .card-category { font-size: 0.8rem; background-color: var(--color-border); color: #c9d1d9; padding: 4px 8px; border-radius: 20px; border: 1px solid #30363d; }
</style>